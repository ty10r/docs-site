<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="keywords" content="munit, testing, unit testing">
  <link rel="canonical" href="https://ede65566-docs-migration.github.io/docs-site/munit/1.3/run-and-wait-scope.html">
  <link rel="stylesheet" href="../../_theme/stylesheets/theme.css">
  <title>Run and Wait Scope // MuleSoft Documentation</title>
</head>
<body class="article">
<header class="header" id="header" role="banner"><div class="header__wrapper clearfix">
      <div class="header__logo--primary-nav clearfix">
        <a href="https://docs.mulesoft.com" title="Home" rel="home" class="header__logo" id="logo">
          <img src="../../_theme/images/mulesoft-dev-logo.svg" alt="Home" class="header__logo-image"></a>
          <div class="header__region region region-header">
    <div id="block-system-main-menu" class="block block-menu first last odd" role="navigation">

        <h2 class="block__title block-title">Main Dev Menu</h2>
    
  <ul class="menu"><li class="menu__item is-expanded first expanded"><span class="menu__link">Platform</span><ul class="menu"><li class="menu__item is-leaf first leaf"><a href="https://developer.mulesoft.com/dev/anypoint-studio" title="" class="menu__link">Studio</a></li>
<li class="menu__item is-leaf leaf"><a href="https://developer.mulesoft.com/dev/connectors" title="" class="menu__link">Connectors</a></li>
<li class="menu__item is-leaf leaf"><a href="https://developer.mulesoft.com/dev/anypoint-exchange" title="" class="menu__link">Exchange</a></li>
<li class="menu__item is-leaf leaf"><a href="https://developer.mulesoft.com/dev/design-api" title="" class="menu__link">API Designer</a></li>
<li class="menu__item is-leaf leaf"><a href="https://developer.mulesoft.com/dev/api-developer-portal" title="" class="menu__link">API Portal</a></li>
<li class="menu__item is-leaf leaf"><a href="https://developer.mulesoft.com/dev/mule-runtime-engine" title="" class="menu__link">Mule runtime engine</a></li>
<li class="menu__item is-leaf leaf"><a href="https://developer.mulesoft.com/dev/api-management" title="" class="menu__link">API Manager</a></li>
<li class="menu__item is-leaf last leaf"><a href="https://developer.mulesoft.com/dev/reporting-api-analytics" title="" class="menu__link">API Analytics</a></li>
</ul></li>
<li class="menu__item is-expanded expanded"><span class="menu__link">Resources</span><ul class="menu"><li class="menu__item is-leaf first leaf"><a href="https://developer.mulesoft.com/getting-started/anypoint-platform" class="menu__link">Getting started</a></li>
<li class="menu__item is-leaf leaf"><a href="https://developer.mulesoft.com/tutorials-and-howtos" class="menu__link">Tutorials &amp; HowTos</a></li>
<li class="menu__item is-leaf leaf"><a href="https://developer.mulesoft.com/webinars-and-videos" title="" class="menu__link">Webinars &amp; Videos</a></li>
<li class="menu__item is-leaf leaf"><a href="http://s2.developer.mulesoft.com/workshops" class="menu__link">Online Workshops</a></li>
<li class="menu__item is-leaf leaf"><a href="https://developer.mulesoft.com/integration-books-and-resources" class="menu__link">Books &amp; Whitepapers</a></li>
<li class="menu__item is-leaf leaf"><a href="https://blogs.mulesoft.com/dev/" class="menu__link">Blog</a></li>
<li class="menu__item is-leaf leaf"><a href="https://docs.mulesoft.com" class="menu__link">Documentation</a></li>
<li class="menu__item is-leaf last leaf"><a href="https://training.mulesoft.com" class="menu__link">Training</a></li>
</ul></li>
<li class="menu__item is-expanded expanded"><a href="https://developer.mulesoft.com/community" class="menu__link">Community</a><ul class="menu"><li class="menu__item is-leaf first leaf"><a href="http://forum.mulesoft.org/" class="menu__link">Forums</a></li>
<li class="menu__item is-leaf leaf"><a href="https://meetups.mulesoft.com" class="menu__link">Meetups</a></li>
<li class="menu__item is-leaf leaf"><a href="http://s2.developer.mulesoft.com/" class="menu__link">Contributed Content</a></li>
<li class="menu__item is-leaf leaf"><a href="https://s2.developer.mulesoft.com/jobs.html" class="menu__link">Jobs</a></li>
<li class="menu__item is-leaf last leaf"><a href="https://www.mulesoft.org/jira/browse/MULE" class="menu__link">Issue tracker</a></li>
</ul></li>
<li class="menu__item is-leaf last leaf"><a href="https://developer.mulesoft.com/champions" class="menu__link">Champions</a></li>
</ul></div>
  </div>
      </div> <!-- header__logo--primary-nav -->
      <div class="header__top-wrapper">
        <div class="header__nav-wrapper">
                      <div class="region region-header-top">
    <div id="block-search-form" class="block block-search first last odd" role="search">

      
  
</div>
  </div>
        </div>
        <div class="top-nav-ctas">
          <a class="icon-muletheme-phone" href="https://mulesoft.com/lp/contact" onclick="ga('send', 'event', 'CTA', 'Click', 'dmc-top-contact');"></a>
          <a href="https://anypoint.mulesoft.com/login/#/signup?apintent=dmc_generic" class="try" onclick="ga('send', 'event', 'CTA', 'Click', 'dmc-top-nav');">Try now</a>
          <a href="https://mulesoft.com/" class="dev" onclick="ga('send', 'event', 'CTA', 'Click', 'dmc-top-mscom');">MuleSoft.com</a>
        </div>
      </div> <!-- header__secondary-nav-search -->
    </div> <!-- header__wrapper -->
    <a href="#sidr" id="open-left" class="closed">
    </a>
  </header><main role="main" class="main-wrapper">
  <div class="navigation-wrapper">
    <nav role="navigation" class="navigation">
      <div class="search">
        <input type="text" placeholder="Search the docs" class="search-input" autocomplete="off" autocorrect="off" autocapitalize="off">
      </div>
      <div class="inner-nav">
          <ul class="nav-lst">
              <li class="nav-itm" data-depth="0" data-state="collapsed">
                  <button class="nav-tgl"></button>
                <a class="nav-lnk" href="index.html">MUnit</a>
                  <ul class="nav-lst">
                      <li class="nav-itm" data-depth="1" data-state="collapsed">
                        <a class="nav-lnk" href="using-munit-in-anypoint-studio.html">Using MUnit in Anypoint Studio</a>
                      </li>
                      <li class="nav-itm" data-depth="1" data-state="collapsed">
                        <a class="nav-lnk" href="munit-suite.html">MUnit Suite</a>
                      </li>
                      <li class="nav-itm" data-depth="1" data-state="collapsed">
                        <a class="nav-lnk" href="mock-message-processor.html">Mock Message Processor</a>
                      </li>
                      <li class="nav-itm" data-depth="1" data-state="collapsed">
                        <a class="nav-lnk" href="verify-message-processor.html">Verify Message Processor</a>
                      </li>
                      <li class="nav-itm" data-depth="1" data-state="collapsed">
                        <a class="nav-lnk" href="set-message-processor.html">Set Message Processor</a>
                      </li>
                      <li class="nav-itm" data-depth="1" data-state="collapsed">
                        <a class="nav-lnk" href="spy-message-processor.html">Spy Message Processor</a>
                      </li>
                      <li class="nav-itm" data-depth="1" data-state="collapsed">
                        <a class="nav-lnk" href="assertion-message-processor.html">Assertion Message Processor</a>
                      </li>
                      <li class="nav-itm" data-depth="1" data-state="collapsed">
                        <a class="nav-lnk" href="munit-matchers.html">MUnit Matchers</a>
                      </li>
                      <li class="nav-itm" data-depth="1" data-state="collapsed">
                        <a class="nav-lnk" href="munit-database-server.html">MUnit Database Server</a>
                      </li>
                      <li class="nav-itm" data-depth="1" data-state="collapsed">
                        <a class="nav-lnk" href="munit-ftp-server.html">MUnit FTP Server</a>
                      </li>
                      <li class="nav-itm" data-depth="1" data-state="collapsed">
                        <a class="nav-lnk" href="munit-maven-support.html">MUnit Maven Support</a>
                      </li>
                      <li class="nav-itm" data-depth="1" data-state="collapsed">
                        <a class="nav-lnk" href="munit-short-tutorial.html">MUnit Short Tutorial</a>
                      </li>
                      <li class="nav-itm" data-depth="1" data-state="collapsed">
                        <a class="nav-lnk" href="example-testing-apikit.html">Example: Testing APIKit</a>
                      </li>
                      <li class="nav-itm" data-depth="1" data-state="collapsed">
                        <a class="nav-lnk" href="logging-in-munit.html">Logging in MUnit</a>
                      </li>
                      <li class="nav-itm" data-depth="1" data-state="collapsed">
                        <a class="nav-lnk" href="run-and-wait-scope.html">Run and Wait Scope</a>
                      </li>
                      <li class="nav-itm" data-depth="1" data-state="collapsed">
                        <a class="nav-lnk" href="munit-tests-with-java.html">MUnit Tests With Java</a>
                      </li>
                      <li class="nav-itm" data-depth="1" data-state="collapsed">
                        <a class="nav-lnk" href="../../solutions/migration/munit/1.1-migration-guide.html">MUnit 1.1 Migration Guide</a>
                      </li>
                  </ul>
              </li>
          </ul>
      </div>
    </nav>
  </div>
  <article class="primary-content">
    <header class="article-header">
      <div class="breadcrumb">
        <strong class="breadcrumb-item">[ Domain Selector Placeholder ]</strong> /
        <span class="breadcrumb-item">Run and Wait Scope</span>
      </div>
      <div class="edit-on-github">
        <a href="https://github.com/ede65566-docs-migration/munit-docs/edit/v1.1/modules/ROOT/content/run-and-wait-scope.adoc" class="edit-on-github-link">Edit on Github</a>
      </div>
    </header>
    <h1>Run and Wait Scope</h1>
    <div class="sect1">
<h2 id="functionality"><a class="anchor" href="#functionality"></a>Functionality</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Run and Wait scope provided by MUnit allows you to instruct MUnit to wait until all asynchronous executions have completed. Hence, test execution does not start until all threads opened by production code have finished processing.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="defining-run-and-wait"><a class="anchor" href="#defining-run-and-wait"></a>Defining Run and Wait</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In some cases, your production code may launch threads that produce key results. Usually, these are the results that you want to validate. But if those results are being processed in a separate thread, your test runs and finishes before that separate thread completes, that is, before the results that you want to validate are available. To avoid this problem, you can use the <code>run-and-wait</code> scope.</p>
</div>
<div class="paragraph">
<p>For the purposes of this document, we assume that we are testing the following Mule code:</p>
</div>
<div class="listingblock">
<div class="title">Test code</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;flow name="exampleFlow"&gt;
  &lt;async&gt;
      &lt;expression-component&gt;
          Thread.sleep(3000);
      &lt;/expression-component&gt;
  &lt;/async&gt;
&lt;/flow&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The goal is to make your test wait until the <code>exampleFlow</code> has finished. To do so, implement the test as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;flow name="testFlow"&gt;
    &lt;synchronize:run-and-wait timeout="16000"&gt; <i class="conum" data-value="1"></i><b>(1)</b>
        &lt;flow-ref name="exampleFlow"/&gt; <i class="conum" data-value="2"></i><b>(2)</b>
    &lt;/synchronize:run-and-wait&gt;
&lt;/flow&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Define <code>run-and-wait</code> scope.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Call the actual production code to test.</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>timeout</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines the time (in milliseconds) to wait for all the threads to complete.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Using this tool is the only way to run an MUnit test on Mule batch jobs.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="defining-run-and-wait-with-java-code"><a class="anchor" href="#defining-run-and-wait-with-java-code"></a>Defining Run and Wait With Java Code</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="java-api-usage"><a class="anchor" href="#java-api-usage"></a>Java API usage</h3>
<div class="paragraph">
<p>To define the <code>run-and-wait</code> scope in Java, you need to implement the <code>Synchronizer</code> abstract class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.mule.construct.Flow;
import org.mule.Synchronizer;
import org.mule.api.MuleEvent;

public class TheTest extends FunctionalMunitSuite {

  @Test
  public void test() throws Exception{
    final Flow flow = (Flow) muleContext.getRegistry().
      lookupFlowConstruct("testFlow");   <i class="conum" data-value="1"></i><b>(1)</b>

    Synchronizer synchronizer =
      new Synchronizer(muleContext, 12000){  <i class="conum" data-value="2"></i><b>(2)</b>

        @Override
        protected MuleEvent process(MuleEvent event) throws Exception{

            return flow.process(event);  <i class="conum" data-value="3"></i><b>(3)</b>
        }
    };

    MuleEvent event = testEvent("payload");
    synchronizer.runAndWait(event);   <i class="conum" data-value="4"></i><b>(4)</b>
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Obtain the flow to test.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Create a new <code>Synchronizer</code> and implement the abstract method <code>process</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Usually what you want to do is run a flow.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Call the <code>Synchronizer</code> implementation defined in Note #2.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
  </article>
</main>
<footer class="footer"><div class="footer__wrapper">
      <div class="footer__top">
              </div>
      <div class="footer-bottom-wrapper">
        <!--<a href="/" title="Home" rel="home" class="header__logo" id="logo"><img src="/sites/all/themes/muletheme/images/mule_logo.svg" alt="Home" class="header__logo-image" /></a>-->
        <div class="connect-footer">
          <p>Sign up for our Dev newsletter</p>
          <div class="connect-footer">

</div>
  </div>
        <div class="terms-conditions temp">
          <div id="block-menu-menu-footer-bottom-menu" class="block block-menu contextual-links-region first last odd" role="navigation">
            <ul class="menu"><li class="menu__item is-leaf leaf"><a href="https://www.mulesoft.com/" class="menu__link">MuleSoft.com</a></li>
              <li class="menu__item is-leaf leaf"><a href="https://blogs.mulesoft.com/" class="menu__link">Blog</a></li>
              <li class="menu__item is-leaf leaf"><a href="https://www.mulesoft.com/content/terms-service" class="menu__link">Terms</a></li>
              <li class="menu__item is-leaf leaf"><a href="https://www.mulesoft.com/privacy-policy" class="menu__link">Privacy</a></li>
              <li class="menu__item is-leaf leaf"><a href="https://www.mulesoft.com/contact" class="menu__link">Contact</a></li>
            </ul></div>
                    <div class="default-terms-conditions">
          </div>
          MuleSoft provides a widely used <a href="https://www.mulesoft.com/platform/enterprise-integration">integration platform</a> for connecting SaaS and enterprise applications in the cloud and on-premise. Delivered as a unified integration experience, <a href="https://www.mulesoft.com/platform/saas/cloudhub-ipaas-cloud-based-integration">CloudHub&trade;</a> and <a href="https://www.mulesoft.com/platform/soa/mule-esb-open-source-esb">Mule ESB&trade;</a> (Enterprise Service Bus) are built on proven open source technology for fast and reliable on-premise and cloud integration without vendor lock-in.


        </div>
      </div>
      <div class="footer-end">
        <div class="footer-logo-wrapper">
          <a href="https://developer.mulesoft.com/" class="footer-logo"></a>
        </div>
        <ul class="social-links"><li><a href="https://www.mulesoft.com/lp/contact" target="_blank" class="icon-muletheme-phone"></a></li>
          <li><a href="https://www.linkedin.com/company/mulesoft" target="_blank" class="icon-muletheme-linkedin"></a></li>
          <li><a href="https://twitter.com/muledev" target="_blank" class="icon-muletheme-twitter"></a></li>
          <li><a href="https://www.facebook.com/MuleSoft" target="_blank" class="icon-muletheme-facebook"></a></li>
          <li><a href="mailto:info@mulesoft.com" target="_blank" class="icon-muletheme-email"></a></li>
          <li><a href="https://videos.mulesoft.com/" target="_blank" class="icon-muletheme-youtube"></a></li>
        </ul><p class="copyright"><span>&copy;2017</span> MuleSoft, INC.</p>
      </div>
    </div>
    </footer><script src="../../_theme/scripts/menu.js"></script>
<script src="../../_theme/scripts/highlight.pack.js"></script>
<script>hljs.initHighlighting()</script>
</body>
</html>
